{{define "title"}}Dashboard - Homelab IPAM{{end}}

{{define "content"}}
<!-- Custom Styles Moved to static/css/style.css -->

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
    <h1 class="page-title">
        Network Devices</h1>
    <div style="display: flex; gap: 0.75rem;">
        <a href="/export/csv" class="btn btn-secondary" style="font-size: 0.875rem;">
            Export CSV
        </a>
        <a href="/export/json" class="btn btn-secondary" style="font-size: 0.875rem;">
            Export JSON
        </a>
        <a href="/add-rack" class="btn btn-secondary">
            <span style="font-size: 1.2rem; line-height: 1;">+</span> Add Rack
        </a>
        <a href="/add" class="btn btn-primary">
            <span style="font-size: 1.2rem; line-height: 1;">+</span> Add Device
        </a>
    </div>
</div>

<!-- Summary Stats -->
<div class="summary-stats">
    <div class="stat-card">
        <div class="stat-value">{{.Subnet}}.x</div>
        <div class="stat-label">Active Subnet</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-used">{{.UsedIPs}}</div>
        <div class="stat-label">Used IPs</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-free">{{.FreeIPs}}</div>
        <div class="stat-label">Free IPs</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-util">{{.UsagePercent}}%</div>
        <div class="stat-label">Utilization</div>
    </div>
</div>

<!-- Devices Grouped by Rack -->
{{range .RackGroups}}
<div class="card card-flush">
    <div class="card-header">
        <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="var(--accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                <line x1="6" y1="6" x2="6.01" y2="6"></line>
                <line x1="6" y1="18" x2="6.01" y2="18"></line>
            </svg>
            {{.Rack.Name}}
            {{if .Rack.Location}}<span style="font-weight: 400; color: var(--text-secondary); font-size: 0.9rem;"> â€”
                {{.Rack.Location}}</span>{{end}}

            {{if eq .Rack.Status "Online"}}
            <span class="status-badge status-online" style="margin-left: 0.75rem;">Online</span>
            {{else if eq .Rack.Status "Offline"}}
            <span class="status-badge status-offline" style="margin-left: 0.75rem;">Offline</span>
            {{else if eq .Rack.Status "Maintenance"}}
            <span class="status-badge status-reserved" style="margin-left: 0.75rem;">Maintenance</span>
            {{end}}

            <span style="margin-left: auto; display: flex; gap: 1rem; align-items: center;">
                <span style="font-size: 0.85rem; font-weight: 400; color: var(--text-secondary);">{{len .Devices}}
                    device(s)</span>
                <a href="/edit-rack?id={{.Rack.ID}}"
                    style="color: var(--accent-primary); opacity: 0.7; transition: opacity 0.2s;" title="Edit Rack">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </a>
                <a href="/delete-rack?id={{.Rack.ID}}" style="color: #fca5a5; opacity: 0.7; transition: opacity 0.2s;"
                    onclick="return confirm('Delete this rack and its devices?')" title="Delete Rack">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </a>
            </span>
        </h3>
    </div>
    {{if .Devices}}
    <div class="card-body" style="padding: 0;">
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="/?sort=hostname&order={{if eq $.Sort " hostname"}}{{if eq $.Order "asc"
                            }}desc{{else}}asc{{end}}{{else}}asc{{end}}"
                            style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px; cursor: pointer;"
                            title="Sort by Hostname">
                            Hostname
                            {{if eq $.Sort "hostname"}}
                            {{if eq $.Order "asc"}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m18 15-6-6-6 6" />
                            </svg>
                            {{else}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6" />
                            </svg>
                            {{end}}
                            {{end}}
                        </a>
                    </th>
                    <th>
                        <a href="/?sort=ip&order={{if eq $.Sort " ip"}}{{if eq $.Order "asc"
                            }}desc{{else}}asc{{end}}{{else}}asc{{end}}"
                            style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px; cursor: pointer;"
                            title="Sort by IP">
                            IP Address
                            {{if eq $.Sort "ip"}}
                            {{if eq $.Order "asc"}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m18 15-6-6-6 6" />
                            </svg>
                            {{else}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6" />
                            </svg>
                            {{end}}
                            {{end}}
                        </a>
                    </th>
                    <th>MAC Address</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .Devices}}
                <tr>
                    <td style="font-weight: 500; color: var(--text-primary);">{{.Hostname}}</td>
                    <td>
                        {{$deviceID := .ID}}
                        {{range .Interfaces}}
                        <div
                            style="font-family: monospace; color: var(--accent-color); font-size: 0.9em; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                            <a href="javascript:void(0)" onclick="pingDevice({{$deviceID}}, '{{.IPAddress}}', this)"
                                title="Ping {{.IPAddress}}"
                                style="color: var(--text-secondary); display: flex; align-items: center;">
                                <span class="ping-icon" style="display: flex;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                                    </svg>
                                </span>
                            </a>
                            <span>{{.IPAddress}}</span>
                            {{if .Label}}<span
                                style="color: var(--text-secondary); font-size: 0.8em; margin-left: 5px;">({{.Label}})</span>{{end}}
                        </div>
                        {{end}}
                    </td>
                    <td>
                        {{range .Interfaces}}
                        <div
                            style="font-family: monospace; opacity: 0.7; font-size: 0.9em; margin-bottom: 4px; height: 19px;">
                            {{if .MACAddress}}{{.MACAddress}}{{else}}-{{end}}
                        </div>
                        {{end}}
                    </td>
                    <td>{{.DeviceType}}</td>
                    <td>
                        {{if eq .Status "Online"}}
                        <span class="status-badge status-online">Online</span>
                        {{else if eq .Status "Offline"}}
                        <span class="status-badge status-offline">Offline</span>
                        {{else}}
                        <span class="status-badge status-reserved">{{.Status}}</span>
                        {{end}}
                    </td>
                    <td>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <a href="/edit?id={{.ID}}" style="color: var(--accent-color); text-decoration: none;"
                                title="Edit Device">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </a>
                            <a href="/delete?id={{.ID}}" style="color: #fca5a5; text-decoration: none;"
                                onclick="return confirm('Are you sure you want to delete this device?')"
                                title="Delete Device">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
        <p>No devices in this rack.</p>
    </div>
    {{end}}
</div>
{{end}}

<!-- Unassigned Devices -->
{{if .UnassignedDevices}}
<div class="card card-flush">
    <div class="card-header">
        <h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="#eab308" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            Unassigned Devices
            <span style="margin-left: auto; font-size: 0.85rem; font-weight: 400; color: var(--text-secondary);">{{len
                .UnassignedDevices}} device(s)</span>
        </h3>
    </div>
    <div class="card-body" style="padding: 0;">
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="/?sort=hostname&order={{if eq $.Sort " hostname"}}{{if eq $.Order "asc"
                            }}desc{{else}}asc{{end}}{{else}}asc{{end}}"
                            style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px; cursor: pointer;"
                            title="Sort by Hostname">
                            Hostname
                            {{if eq $.Sort "hostname"}}
                            {{if eq $.Order "asc"}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m18 15-6-6-6 6" />
                            </svg>
                            {{else}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6" />
                            </svg>
                            {{end}}
                            {{end}}
                        </a>
                    </th>
                    <th>
                        <a href="/?sort=ip&order={{if eq $.Sort " ip"}}{{if eq $.Order "asc"
                            }}desc{{else}}asc{{end}}{{else}}asc{{end}}"
                            style="color: inherit; text-decoration: none; display: flex; align-items: center; gap: 4px; cursor: pointer;"
                            title="Sort by IP">
                            IP Address
                            {{if eq $.Sort "ip"}}
                            {{if eq $.Order "asc"}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m18 15-6-6-6 6" />
                            </svg>
                            {{else}}
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6" />
                            </svg>
                            {{end}}
                            {{end}}
                        </a>
                    </th>
                    <th>MAC Address</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .UnassignedDevices}}
                <tr>
                    <td style="font-weight: 500; color: var(--text-primary);">{{.Hostname}}</td>
                    <td>
                        {{$deviceID := .ID}}
                        {{range .Interfaces}}
                        <div
                            style="font-family: monospace; color: var(--accent-primary); font-size: 0.9em; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                            <a href="javascript:void(0)" onclick="pingDevice({{$deviceID}}, '{{.IPAddress}}', this)"
                                title="Ping {{.IPAddress}}"
                                style="color: var(--text-secondary); display: flex; align-items: center;">
                                <span class="ping-icon" style="display: flex;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                                    </svg>
                                </span>
                            </a>
                            <span>{{.IPAddress}}</span>
                            {{if .Label}}<span
                                style="color: var(--text-secondary); font-size: 0.8em; margin-left: 5px;">({{.Label}})</span>{{end}}
                        </div>
                        {{end}}
                    </td>
                    <td>
                        {{range .Interfaces}}
                        <div
                            style="font-family: monospace; opacity: 0.7; font-size: 0.9em; margin-bottom: 4px; height: 19px;">
                            {{if .MACAddress}}{{.MACAddress}}{{else}}-{{end}}
                        </div>
                        {{end}}
                    </td>
                    <td>{{.DeviceType}}</td>
                    <td>
                        {{if eq .Status "Online"}}
                        <span class="status-badge status-online">Online</span>
                        {{else if eq .Status "Offline"}}
                        <span class="status-badge status-offline">Offline</span>
                        {{else}}
                        <span class="status-badge status-reserved">{{.Status}}</span>
                        {{end}}
                    </td>
                    <td>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <a href="/edit?id={{.ID}}" style="color: var(--accent-primary); text-decoration: none;"
                                title="Edit Device">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </a>
                            <a href="/delete?id={{.ID}}" style="color: #fca5a5; text-decoration: none;"
                                onclick="return confirm('Are you sure you want to delete this device?')"
                                title="Delete Device">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{end}}

<!-- No devices at all -->
{{if and (not .RackGroups) (not .UnassignedDevices)}}
<div class="card" style="text-align: center; padding: 3rem; color: var(--text-secondary); margin-bottom: 2rem;">
    <p style="margin-bottom: 1rem;">No devices found.</p>
    <a href="/add" class="btn btn-secondary">Add your first device</a>
</div>
{{end}}

<!-- IP Map Section -->
<div class="card card-flush">
    <div class="card-header" style="justify-content: space-between;">
        <h3 style="width: auto;">Subnet Map ({{.Subnet}}.0/24)</h3>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <!-- Legend -->
            <div
                style="display: flex; gap: 0.75rem; font-size: 0.8rem; color: var(--text-secondary); margin-right: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.35rem;">
                    <div class="ip-box ip-free"
                        style="width: 12px; height: 12px; min-height: 0; padding: 0; pointer-events: none;"></div>
                    Free
                </div>
                <div style="display: flex; align-items: center; gap: 0.35rem;">
                    <div class="ip-box ip-used"
                        style="width: 12px; height: 12px; min-height: 0; padding: 0; pointer-events: none;"></div>
                    Used
                </div>
                <div style="display: flex; align-items: center; gap: 0.35rem;">
                    <div class="ip-box ip-discovered"
                        style="width: 12px; height: 12px; min-height: 0; padding: 0; pointer-events: none;"></div>
                    Active
                </div>
                <div style="display: flex; align-items: center; gap: 0.35rem;">
                    <div class="ip-box ip-reserved"
                        style="width: 12px; height: 12px; min-height: 0; padding: 0; pointer-events: none;"></div>
                    Reserved
                </div>
            </div>

            <button onclick="scanNetwork()" class="btn btn-secondary" id="scanBtn"
                style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-right: 4px;">
                    <path d="M2 12h20" />
                    <path d="M12 2v20" />
                    <path d="m4.93 4.93 14.14 14.14" />
                    <path d="m19.07 4.93-14.14 14.14" />
                </svg>
                Scan Network
            </button>
        </div>
    </div>

    <div class="card-body">
        <div class="ip-grid">
            {{range .IPMap}}
            {{if eq .Status "Free"}}
            <a href="/add?ip={{.IP}}" class="ip-box ip-free ip-item" data-ip="{{.IP}}" title="Free IP: {{.IP}}">
                {{.Octet}}
            </a>
            {{else if eq .Status "Used"}}
            <a href="/edit?id={{.DeviceID}}" class="ip-box ip-used ip-item" data-ip="{{.IP}}"
                title="Used by: {{.Hostname}} ({{.IP}})">
                <span class="ip-octet">{{.Octet}}</span>
                <span class="ip-hostname">{{if .Hostname}}{{.Hostname}}{{else}}-{{end}}</span>
            </a>
            {{else}}
            <a href="/edit?id={{.DeviceID}}" class="ip-box ip-reserved ip-item" data-ip="{{.IP}}"
                title="Reserved: {{.Hostname}} ({{.IP}})">
                <span class="ip-octet">{{.Octet}}</span>
                <span class="ip-hostname">{{if .Hostname}}{{.Hostname}}{{else}}Reserved{{end}}</span>
            </a>
            {{end}}
            {{end}}
        </div>
    </div>
</div>

<script>
    const ICONS = {
        default: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
        loading: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`,
        success: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>`
    };

    const style = document.createElement('style');
    style.innerHTML = `
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.animate-spin { animation: spin 1s linear infinite; }
`;
    document.head.appendChild(style);

    async function pingDevice(id, ip, linkElement) {
        const iconSpan = linkElement.querySelector('.ping-icon');
        iconSpan.innerHTML = ICONS.loading;
        linkElement.style.pointerEvents = "none";
        try {
            const response = await fetch(`/ping?id=${id}&ip=${ip}`);
            const data = await response.json();
            if (data.success) {
                iconSpan.innerHTML = ICONS.success;
            } else {
                iconSpan.innerHTML = ICONS.error;
                console.error(data.output);
                alert("Ping Failed for " + ip + ":\n" + data.output);
            }
        } catch (error) {
            console.error(error);
            iconSpan.innerHTML = ICONS.error;
            alert("Error: " + error.message);
        } finally {
            linkElement.style.pointerEvents = "auto";
        }
    }

    async function scanNetwork() {
        const btn = document.getElementById('scanBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Scanning...';
        btn.disabled = true;

        try {
            const response = await fetch('/scan');
            const data = await response.json();

            if (data.success && data.active_ips) {
                const activeIPs = new Set(data.active_ips);

                // Update grid
                document.querySelectorAll('.ip-item').forEach(el => {
                    const ip = el.getAttribute('data-ip');
                    if (activeIPs.has(ip)) {
                        // If it's free, mark as discovered
                        if (el.classList.contains('ip-free')) {
                            el.classList.remove('ip-free');
                            el.classList.add('ip-discovered');
                            el.title = "Discovered (Active) - Click to Add";
                        }
                        // If used, could add a "online" glow, or just leave it
                        // Optional: Add a small dot or border
                    }
                });

                // Update Stats (Used = DB Used + Scanned Active)
                const usedCount = document.querySelectorAll('.ip-used, .ip-reserved, .ip-discovered').length;
                const totalIPs = 254;
                const freeCount = totalIPs - usedCount;
                const utilPercent = Math.round((usedCount * 100) / totalIPs);

                document.getElementById('stat-used').textContent = usedCount;
                document.getElementById('stat-free').textContent = freeCount;
                document.getElementById('stat-util').textContent = utilPercent + '%';
            }
        } catch (e) {
            console.error("Scan failed", e);
            alert("Network scan failed.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Auto-scan on load
    window.onload = function () {
        scanNetwork();
    };

</script>
{{end}}